{% load static django_bootstrap5  fec_filters %}

<!doctype html>
<html lang="vi">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Dashboard khách hàng</title>
    {% bootstrap_css %}
    <link rel="stylesheet" href="{% static 'css/app.css' %}">
</head>
<body>
<div class="wrap">
    <div class="d-flex align-items-center justify-content-between mb-3">
        <h3 class="mb-0 text-primary">Dashboard khách hàng</h3>
        <div>
            {% if request.user.is_authenticated %}
                <span class='me-3 text-muted small'>Xin chào,  {{ request.user.get_full_name|default:request.user.email }}</span>
            {% endif %}
            
            {% if request.user.is_authenticated and request.user.is_superuser %}
            <a class="btn btn-outline-secondary me-2" href="{% url 'admin:index' %}" target="_blank">Admin</a>
            {% endif %}

            <a class="btn btn-outline-secondary btn" href="{% url 'accounts:change_password' %}">Đổi mật khẩu</a>

            <form action="{% url 'accounts:logout' %}" method="post" class="d-inline">
                {% csrf_token %}
                <button type="submit" class="btn btn-outline-danger">
                Logout
                </button>
            </form>
            <a class="btn btn-success" href="{% url 'management:export_csv' %}?{{ request.GET.urlencode }}">Xuất CSV</a>
        </div>
    </div>

    <div class="card shadow-sm mb-3">
        <div class="card-body">
        <form method="get" class="row g-2">
            <div class="col-12 col-md-3">
            <label class="form-label">Tìm kiếm</label>{{ form.q }}
            </div>
            <div class="col-6 col-md-2">
            <label class="form-label">Từ ngày</label>{{ form.date_from }}
            </div>
            <div class="col-6 col-md-2">
            <label class="form-label">Đến ngày</label>{{ form.date_to }}
            </div>
            <div class="col-6 col-md-2">
            <label class="form-label">Tỉnh/TP</label>{{ form.province }}
            </div>
            <div class="col-6 col-md-2">
            <label class="form-label">Công việc</label>{{ form.work_status }}
            </div>
            <div class="col-6 col-md-1">
            <label class="form-label">Giới tính</label>{{ form.gender }}
            </div>
            <div class="col-12 d-flex gap-2 mt-1">
            <button class="btn btn-primary">Lọc</button>
            <a class="btn btn-outline-secondary" href="{% url 'management:dashboard' %}">Xóa lọc</a>
            </div>
        </form>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
            <tr>
                <th>#</th>
                <th>Họ tên</th>
                <th>Giới tính</th>
                <th>SĐT</th>
                <th>CCCD</th>
                <th>Tỉnh/TP</th>
                <th>Thu nhập</th>
                <th>Đăng ký</th>
                <th>Tạo lúc</th>
                <th class="text-center">PDF</th>
                <th></th>
            </tr>
            </thead>
            <tbody>
            {% for r in rows %}
            <tr>
                <td>{{ r.id }}</td>
                <td>{{ r.full_name }}</td>
                <td>{{ r.get_gender_display }}</td>
                <td>{{ r.phone_number | phone_vn }}</td>
                <td>{{ r.id_card }}</td>
                <td>{{ r.get_permanent_address_display }}</td>
                <td>{{ r.income|money_vn }}</td>
                <td>{{ r.loan_amount|money_vn }}</td>
                <td>{{ r.created_at|date:"H:i d/m/Y" }}</td>
                <td class="text-center">
                    {% if r.signature_document %}
                        <a class="btn btn-sm btn-danger
                        "
                        href="{% url 'management:download_file' r.id %}"
                        title="Tải văn bản xác nhận (PDF)">
                        Tải PDF
                        </a>
                        {# Nếu muốn mở tab mới: thêm target="_blank" rel="noopener" #}
                    {% else %}
                        <span class="badge bg-secondary">Chưa có</span>
                    {% endif %}
                </td>
                <td><a class="btn btn-sm btn-outline-primary" href="{% url 'management:customer_detail' r.pk %}">Chi tiết</a></td>
            </tr>
            {% empty %}
            <tr><td colspan="10" class="text-center text-muted py-4">Chưa có dữ liệu</td></tr>
            {% endfor %}
            </tbody>
        </table>
        </div>

        {% if is_paginated %}
        <div class="card-body">
        <nav>
            <ul class="pagination mb-0">
            {% if page_obj.has_previous %}
                <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if querystring %}&{{ querystring }}{% endif %}">«</a>
                </li>
            {% else %}<li class="page-item disabled"><span class="page-link">«</span></li>{% endif %}

            <li class="page-item disabled"><span class="page-link">
                Trang {{ page_obj.number }}/{{ page_obj.paginator.num_pages }}
            </span></li>

            {% if page_obj.has_next %}
                <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if querystring %}&{{ querystring }}{% endif %}">»</a>
                </li>
            {% else %}<li class="page-item disabled"><span class="page-link">»</span></li>{% endif %}
            </ul>
        </nav>
        </div>
        {% endif %}
    </div>
</div>
{% bootstrap_javascript %}

<script>
    // Luôn có toast ở phạm vi global
    (function () {
    // Nếu đã có thì không ghi đè
    if (window.toast) return;

    window.toast = function(msg, ms = 3000) {
        const el = document.createElement('div');
        el.className = 'alert alert-success position-fixed shadow';
        el.style.right = '16px';
        el.style.bottom = '16px';
        el.style.zIndex = 9999;
        el.textContent = msg;
        document.body.appendChild(el);
        setTimeout(() => el.remove(), ms);
    };
    })();
</script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
    const proto = (location.protocol === 'https:') ? 'wss' : 'ws';
    const ws = new WebSocket(`${proto}://${location.host}/ws/dashboard/customers/`);

    // fallback: nếu ai đó xoá toast, vẫn không crash
    const notify = (m) => (window.toast ? window.toast(m) : alert(m));

    ws.onmessage = (e) => {
        let msg;
        try { msg = JSON.parse(e.data); } catch { return; }

        if (msg.kind === 'customer_created') {
        notify(`Có khách mới: ${msg.name || msg.phone || ''}`);
        prependRow(msg); // xem hàm dưới
        // hoặc: location.reload();
        } else if (msg.kind === 'error') {
        console.error('WS server error:', msg.where, msg.detail);
        notify('Realtime lỗi: ' + (msg.detail || ''));
        }
    };

    ws.onopen  = () => console.log('WS open');
    ws.onclose = (e) => console.warn('WS closed:', e.code);
    ws.onerror = (e) => console.error('WS error', e);
    });

    // Chèn dòng mới vào bảng thay vì reload
    function prependRow(m) {
    const tbody = document.querySelector('table tbody');
    if (!tbody) return;

    // Xoá dòng "Chưa có dữ liệu" nếu có
    const empty = tbody.querySelector('td[colspan]');
    if (empty && empty.parentElement) empty.parentElement.remove();

    const esc = (v) => {
        const d = document.createElement('div'); d.textContent = v ?? ''; return d.innerHTML;
    };

    const tr = document.createElement('tr');
    tr.innerHTML = `
        <td>•</td>
        <td>${esc(m.name)}</td>
        <td>${esc(m.gender)}</td>
        <td>${esc(m.phone)}</td>
        <td>${esc(m.citizen_id || '')}</td>
        <td>${esc(m.province || '')}</td>
        <td>${esc(m.income || '')}</td>
        <td>${esc(m.loan || '')}</td>
        <td>${esc(m.created_at || '')}</td>
        <td>${m.has_pdf ? 'Có' : 'Không'}</td>
    `;
    tbody.prepend(tr);
}
</script>


</body>
</html>
