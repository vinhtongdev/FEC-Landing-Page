{% load static django_bootstrap5  fec_filters %}

<!doctype html>
<html lang="vi">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Dashboard khách hàng</title>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

    <script>
        window.WEBPUSH_PUBLIC_KEY = "{{ WEBPUSH_VAPID_PUBLIC_KEY }}";
    </script>
    <script>
        window.PUSH_SUBSCRIBE_URL = "{% url 'management:push_subscribe' %}";
    </script>

    <script defer src="{% static 'js/dashboard.js' %}"></script>
    <script defer src="{% static 'js/dashboard_edit.js' %}"></script>
        {% bootstrap_css %}
    <link rel="stylesheet" href="{% static 'css/app.css' %}">

</head> 
<body>
<div class="wrap">
    <div class="d-flex align-items-center justify-content-between mb-3">
        <h3 class="mb-0 text-primary">Dashboard khách hàng</h3>
        <div>
            {% if request.user.is_authenticated %}
                <span class='me-3 text-muted small'>Xin chào,  {{ request.user.get_full_name|default:request.user.email }}</span>
            {% endif %}
            
            {% if request.user.is_authenticated and perms.report.view_reports %}
            <a class="btn btn-primary me-2" href="{% url 'report:dashboard' %}">Reports</a>
            {% endif %}
            
            {% if request.user.is_authenticated and request.user.is_superuser %}
            <a class="btn btn-outline-secondary me-2" href="{% url 'admin:index' %}" target="_blank">Admin</a>
            {% endif %}

            <a class="btn btn-outline-secondary btn" href="{% url 'accounts:change_password' %}">Đổi mật khẩu</a>

            <form action="{% url 'accounts:logout' %}" method="post" class="d-inline">
                {% csrf_token %}
                <button type="submit" class="btn btn-outline-danger">
                Logout
                </button>
            </form>
            <a class="btn btn-success" href="{% url 'management:export_csv' %}?{{ request.GET.urlencode }}">Xuất CSV</a>
        </div>
    </div>

    <div class="card shadow-sm mb-3">
        <div class="card-body">
        <form method="get" class="row g-2">
            <div class="col-12 col-md-3">
            <label class="form-label">Tìm kiếm</label>{{ form.q }}
            </div>
            <div class="col-6 col-md-2">
            <label class="form-label">Từ ngày</label>{{ form.date_from }}
            </div>
            <div class="col-6 col-md-2">
            <label class="form-label">Đến ngày</label>{{ form.date_to }}
            </div>
            <div class="col-6 col-md-2">
            <label class="form-label">Tỉnh/TP</label>{{ form.province }}
            </div>
            <div class="col-6 col-md-2">
            <label class="form-label">Công việc</label>{{ form.work_status }}
            </div>
            <div class="col-6 col-md-1">
            <label class="form-label">Giới tính</label>{{ form.gender }}
            </div>
            <div class="col-12 d-flex gap-2 mt-1">
            <button class="btn btn-primary">Lọc</button>
            <a class="btn btn-outline-secondary" href="{% url 'management:dashboard' %}">Xóa lọc</a>
            </div>
        </form>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
            <tr>
                <th>#</th>
                <th>Họ tên</th>
                <th>Giới tính</th>
                <th>SĐT</th>
                <th>CCCD</th>
                <th>Tỉnh/TP</th>
                <th>Thu nhập</th>
                <th>Đăng ký</th>
                <th>Tạo lúc</th>
                <th class="text-center">PDF</th>
                <th></th>
                <th></th>
            </tr>
            </thead>
            <tbody>
            {% for r in rows %}
            <tr data-id="{{ r.id }}">
                <td>{{ r.id }}</td>
                <td>{{ r.full_name }}</td>
                <td>{{ r.get_gender_display }}</td>
                <td>{{ r.phone_number | phone_vn }}</td>
                <td>{{ r.id_card }}</td>
                <td>{{ r.get_permanent_address_display }}</td>
                <td>{{ r.income|money_vn }}</td>
                <td>{{ r.loan_amount|money_vn }}</td>
                <td>{{ r.created_at|date:"H:i d/m/Y" }}</td>
                <td class="text-center" data-col="pdf">
                    {% if r.signature_document %}
                        <a class="btn btn-sm btn-danger
                        "
                        href="{% url 'management:download_file' r.id %}"
                        title="Tải văn bản xác nhận (PDF)">
                        Tải PDF
                        </a>
                        {# Nếu muốn mở tab mới: thêm target="_blank" rel="noopener" #}
                    {% else %}
                        <span class="badge bg-secondary">Chưa có</span>
                    {% endif %}
                </td>
                <td><a class="btn btn-sm btn-primary" href="{% url 'management:customer_detail' r.pk %}">Chi tiết</a></td>
                <td class="text-end">
                    <button class="btn btn-sm btn-warning btn-edit" data-id="{{ r.id }}">Chỉnh sửa</button>
                </td>

            </tr>
            {% empty %}
            <tr><td colspan="10" class="text-center text-muted py-4">Chưa có dữ liệu</td></tr>
            {% endfor %}
            </tbody>
        </table>
        </div>

        {% if is_paginated %}
        <div class="card-body">
        <nav>
            <ul class="pagination mb-0">
            {% if page_obj.has_previous %}
                <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if querystring %}&{{ querystring }}{% endif %}">«</a>
                </li>
            {% else %}<li class="page-item disabled"><span class="page-link">«</span></li>{% endif %}

            <li class="page-item disabled"><span class="page-link">
                Trang {{ page_obj.number }}/{{ page_obj.paginator.num_pages }}
            </span></li>

            {% if page_obj.has_next %}
                <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if querystring %}&{{ querystring }}{% endif %}">»</a>
                </li>
            {% else %}<li class="page-item disabled"><span class="page-link">»</span></li>{% endif %}
            </ul>
        </nav>
        </div>
        {% endif %}
    </div>
</div>

<!-- Modal edit -->
<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content" id="editModalContent"></div>
    </div>
</div>

<!-- Modal nhập mã 6 số -->
<div class="modal fade" id="approveModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 16px;">
        <div class="modal-header">
            <h5 class="modal-title">Xác nhận từ Quản lý</h5>
        </div>
        <div class="modal-body">
            <p class="text-muted">Nhập mã 6 số do Quản lý cung cấp để lưu thay đổi.</p>
            <div id="approve-alerts" class="mb-2"></div>
            <input id="approve-code" maxlength="6" class="form-control text-center" placeholder="______" inputmode="numeric" />
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
            <button id="btn-approve-verify" class="btn btn-primary">Xác nhận</button>
        </div>
        </div>
    </div>
</div>
{% bootstrap_javascript %}
<script>
    // Gán biến từ Django context vào biến JS global
    window.IS_USER_MANAGER = {{ is_manager|yesno:'true,false' }};
</script>
</body>
</html>
